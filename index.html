<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Salon Admin Dashboard</title>
  <style>
  :root {
    --primary: #007BFF;
    --accent: #6C757D;
    --background: #FFFFFF;
    --text: #212529;
    --highlight: #17A2B8;
  }

  body {
    font-family: 'Segoe UI', sans-serif;
    background: var(--background);
    padding: 20px;
    margin: 0;
    color: var(--text);
  }

  h2 {
    text-align: center;
    margin-bottom: 10px;
    color: var(--primary);
  }

  .filter-bar {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 5px;
    -webkit-overflow-scrolling: touch;
  }

  .filter-bar button {
    flex: 0 0 auto;
    min-width: 120px;
    padding: 10px 16px;
    border: none;
    background-color: var(--primary);
    color: white;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
  }

  .filter-bar button.active {
    background-color: var(--highlight);
  }

  .day-section {
    margin-bottom: 30px;
    padding: 15px;
    background: var(--background);
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.05);
    border-left: 4px solid var(--accent);
  }

  .day-label {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--accent);
    padding-bottom: 5px;
    color: var(--text);
  }

  .card {
    background: #F8F9FA;
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
  }

  .card p {
    margin: 5px 0;
  }

  .card button {
    margin-right: 10px;
    margin-top: 10px;
    padding: 8px 12px;
    border: none;
    background-color: var(--primary);
    color: white;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  .card button:hover {
    background-color: var(--highlight);
  }

  .message {
    margin-top: 10px;
    color: var(--highlight);
    font-weight: bold;
  }

  .status-badge {
    margin-top: 10px;
    padding: 8px;
    font-weight: bold;
    border-radius: 6px;
    text-align: center;
  }

  .Confirmed {
    background-color: #d4edda;
    color: #155724;
  }

  .Canceled {
    background-color: #f8d7da;
    color: #721c24;
  }

  .Rescheduled {
    background-color: #cce5ff;
    color: #004085;
  }

  @media (max-width: 600px) {
    .card {
      font-size: 14px;
    }
    .card button {
      width: 100%;
      margin-bottom: 5px;
    }
  }
</style>
</head>
<body>
  <h2>Salon Admin Dashboard</h2>

  <div class="filter-bar">
    <button class="active" onclick="setFilter('All')">All</button>
    <button onclick="setFilter('Confirmed')">Confirmed</button>
    <button onclick="setFilter('Canceled')">Canceled</button>
    <button onclick="setFilter('Rescheduled')">Rescheduled</button>
  </div>

  <div id="dashboard"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AlzaSyAGhPaWhjPc9l6cWa4nDkg8Kt3c7H0UzM",
      authDomain: "salonbooking-6d5aa.firebaseapp.com",
      databaseURL: "https://salonbooking-6d5aa-default-rtdb.firebaseio.com/",
      projectId: "salonbooking-6d5aa",
      storageBucket: "salonbooking-6d5aa.appspot.com",
      messagingSenderId: "11411859014",
      appId: "1:11411859014:web:926076fa2feba87280c47"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentFilter = "All";

    function setFilter(status) {
      currentFilter = status;
      document.querySelectorAll(".filter-bar button").forEach(btn => {
        btn.classList.remove("active");
        if (btn.textContent === status) btn.classList.add("active");
      });
      filterAppointments();
    }

    function filterAppointments() {
      document.querySelectorAll(".card").forEach(card => {
        const status = card.getAttribute("data-status");
        card.style.display = (currentFilter === "All" || status === currentFilter) ? "block" : "none";
      });
    }

    function loadAppointments() {
      const container = document.getElementById("dashboard");
      container.innerHTML = "<p>Loading appointments...</p>";

      db.ref("bookings").once("value").then(snapshot => {
        container.innerHTML = "";
        const bookingsByDay = {};

        snapshot.forEach(child => {
          const data = child.val();
          const key = child.key;
          const date = data.Date;
          const timestamp = data.Timestamp ? new Date(data.Timestamp) : new Date(data.Date);
          const today = new Date();
          const diffDays = Math.floor((today - timestamp) / (1000 * 60 * 60 * 24));
          if (diffDays > 7) return;

          if (!bookingsByDay[date]) bookingsByDay[date] = [];
          bookingsByDay[date].push({ key, data });
        });

        const sortedDates = Object.keys(bookingsByDay).sort((a, b) => new Date(b) - new Date(a));

        sortedDates.forEach(date => {
          const section = document.createElement("div");
          section.className = "day-section";

          const label = document.createElement("div");
          label.className = "day-label";
          label.textContent = formatDateLabel(date);
          section.appendChild(label);

          bookingsByDay[date].sort((a, b) => new Date(b.data.Timestamp || b.data.Date) - new Date(a.data.Timestamp || a.data.Date));

          bookingsByDay[date].forEach(({ key, data }) => {
            const card = document.createElement("div");
            card.className = "card";
            card.setAttribute("data-status", data.Status);

            let actions = "";
            if (data.Status === "Pending") {
              actions = `
                <button onclick="updateStatus('${key}', 'Confirmed')">Confirm</button>
                <button onclick="updateStatus('${key}', 'Canceled')">Cancel</button>
                <button onclick="reschedule('${key}')">Reschedule</button>
              `;
            } else {
              actions = `<div class="status-badge ${data.Status}">${data.Status}</div>`;
            }

            card.innerHTML = `
              <p><strong>Name:</strong> ${data.Name}</p>
              <p><strong>Phone:</strong> ${data.Phone}</p>
              <p><strong>Service:</strong> ${data.Service}</p>
              <p><strong>Date:</strong> ${data.Date}</p>
              <p><strong>Time:</strong> ${data.Time}</p>
              <p><strong>Stylist:</strong> ${data.Stylist || "Any"}</p>
              ${data.Message ? `<div class="message">${data.Message}</div>` : ""}
              ${actions}
            `;
            section.appendChild(card);
          });

          container.appendChild(section);
        });

        filterAppointments();
      });
    }

    function updateStatus(refID, newStatus) {
      db.ref("bookings/" + refID).once("value").then(snapshot => {
        const booking = snapshot.val();
        const chatId = booking.chat_id;
        const name = booking.Name;
        const service = booking.Service;
        const date = booking.Date;
        const time = booking.Time;

        let message = "";
        if (newStatus === "Canceled") {
          message = `‚ùå Hello ${name}, your appointment for ${service} on ${date} at ${time} has been canceled. Please contact us to rebook.`;
        } else if (newStatus === "Confirmed") {
          message = `‚úÖ Hi ${name}, your appointment for ${service} on ${date} at ${time} is confirmed. See you soon!`;
        }

        db.ref("bookings/" + refID).update({
          Status: newStatus,
          Message: message
        }).then(() => {
          if (chatId) sendTelegram(chatId, message);
          loadAppointments();
        });
      });
    }

    function reschedule(refID) {
      db.ref("bookings/" + refID).once("value").then(snapshot => {
        const booking = snapshot.val();
        const chatId = booking.chat_id;
        const name = booking.Name;
        const service = booking.Service;

        const newDate = prompt("Enter new date (YYYY-MM-DD):");
        const newTime = prompt("Enter new time (HH:MM):");
        if (!newDate || !newTime) return;

        const message = `üîÑ Hi ${name}, your appointment for ${service} has been rescheduled to ${newDate} at ${newTime}.`;

        db.ref("bookings/" + refID).update({
          Date: newDate,
          Time: newTime,
          Status: "Rescheduled",
          Message: message
        }).then(() => {
          if (chatId) sendTelegram(chatId, message);
          loadAppointments();
        });
      });
    }

    function sendTelegram(chatId, message) {
      fetch("https://api.telegram.org/bot8455761527:AAGJWQoGdo7iBcbV_uaQ8xeEl8A86YA93e8/sendMessage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: chatId,
          text: message
        })
      }).then(() => {
        console.log("Telegram message sent ‚úÖ");
      }).catch(() => {
        console.log("Telegram message failed ‚ùå");
      });
    }

    function formatDateLabel(dateStr) {
      const date = new Date(dateStr);
      return date.toDateString();
    }

    loadAppointments();
  </script>
</body>
</html>
